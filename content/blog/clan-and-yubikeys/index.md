+++
title = "Clan + Yubikeys"
subline = "A side quest through time and space... and AGE plugins, the Clan CLI and more."
date = 2025-05-16T08:00:00+00:00
draft = false
author = "Brian McGee"
tags = ['Dev Report']
+++

All I wanted was to test [Data Mesher]... :upside_down_face:

I had done some local dev testing and created a [NixOS] module with some [VM tests]. 
[Pinpox] had helped write the [Clan module] and added some more Clan-specific VM tests. 
We were ready to start testing this in a real Clan.

Until this point, I wasn't running Clan. I had always meant to convert, but just never got around to
it. So this was as good a reason as any. I fired up the docs, opened up my config and got to work. 

But it wasn't long before I hit a few problems.

## Multiple User Keys

I'm a long-time user of [SOPS] via [sops-nix] for managing secrets within [NixOS] configurations, and I like to use it in
combination with [Yubikeys] via [AGE] plugins. Clan can also use [SOPS] for [secrets management], but it deviates in
one important way. 

Unlike with [SOPS] where you configure keys in a `.sops.yaml` file, Clan takes a more _active role_ in how
[SOPS] keys are configured, introducing concepts like `users`, `groups`, and `machines`. And at the time, the `user` model
didn't allow for _more than one encryption key_.

Why is this important?

Well, to protect against loss or failure of a [Yubikey], I _use more than one_. And, just in case they're all lost or 
broken, I also use a vanilla age key backed up on paper or in a password manager. Ordinarily, this isn't a problem with
[SOPS]. But with Clan, it was a __non-starter__. 

So I [added support for it](https://git.clan.lol/clan/clan-core/pulls/3230). :white_check_mark:

## Age Plugins

Having taken care of multiple user keys, I next found myself dealing with some issues related to [AGE] plugins.

The first was easy enough to fix, ensuring the Clan CLI was loading any necessary [AGE] plugins when decrypting with [SOPS]. 
I added some [packages to an allowlist](https://git.clan.lol/clan/clan-core/src/branch/main/pkgs/clan-cli/clan_cli/nix/allowed-packages.json), 
tweaked the shell being used when [invoking SOPS](https://git.clan.lol/clan/clan-core/src/commit/13fa74b8cd663d5541bb735a1d7ba5b6d91cb450/pkgs/clan-cli/clan_cli/secrets/sops.py#L195-L210)
and added an option allowing a user to specify the plugins they require in their Clan: 

```nix
{
  inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
  inputs.nixpkgs.follows = "clan-core/nixpkgs";

  outputs =
    { self, clan-core, ... }:
    let
      clan = clan-core.clanLib.buildClan {
        inherit self;

        meta.name = "myclan";

        # Add Yubikey and FIDO2 HMAC plugins
        # Note: the plugins listed here must be available in nixpkgs.
        secrets.age.plugins = [
          "age-plugin-yubikey"
          "age-plugin-fido2-hmac"
        ];

        machines = {
          # elided for brevity
        };
      };
    in
    {
      inherit (clan) nixosConfigurations clanInternals;

      # elided for brevity
    };
}
```

### Recovering Recipients

The second issue required a bit more thought, as it turns out there is no uniform mechanism for recovering the 
recipient (public key) from a secret key generated by an [AGE] plugin. 

It's important we can do this because the Clan CLI implements a safety check when creating or updating a secret. 
If the recipient associated with the currently configured [AGE] private key is not in the list of recipients when 
encrypting a secret, we _add that recipient to the list_. 

This helps ensure you __do not encrypt a secret which you cannot decrypt__. 

With vanilla [AGE] keys this isn't a problem, since you can recover the recipient with a simple `age-keygen -y`. 
But for [AGE] plugins, we ended up with a workaround in which a user needs to [prepend a comment with the recipient key](https://docs.clan.lol/getting-started/secrets/#using-age-plugins).

For example, this is what your `~/.config/sops/age/keys.txt` might look like:

```text
# public key: age1zdy49ek6z60q9r34vf5mmzkx6u43pr9haqdh5lqdg7fh5tpwlfwqea356l
AGE-PLUGIN-FIDO2-HMAC-1QQPQZRFR7ZZ2WCV...
```

For each private key in this file, 
we look at the preceding line for a comment containing a recipient of the form `age1xxxx`.
The rest of the line doesn't really matter. 
You can prefix it with `public key:`, `recipient:` or whatever else. 

[AGE plugin support](https://git.clan.lol/clan/clan-core/pulls/3322): :white_check_mark:

## Success?

By this point, I began porting my configuration over to a new repo I had set up for Clan.
I added an initial user key based on [age-plugin-fido2-hmac] and began fleshing out the configuration for my
main desktop machine.

After a while, I remembered that I should add a couple more keys to my user, including my backup key.
No big deal, just a simple `clan secrets users add-key brian age1xxxxxxx` right?

{{< figure src="./pain.jpg" caption="It just keeps asking for my PIN...">}}

## Vars + age-plugin-fido2-hmac = Pain

When adding a new user key, under the hood the Clan CLI is making a call to `sops updatekeys`.
As part of the `updatekeys` process, [sops] needs to decrypt the underlying value to then encrypt it for the key we are
adding. 
Nothing unusual so far. 

The sting in the tail comes when you understand how [Vars] organises secrets on the filesystem: __one file per secret__.

This is in stark contrast to how I had been using [sops] previously, where I typically grouped a number of secrets into
the same file on a per-host or a per-user basis. 
But where's the problem you might be asking? 

__[age-plugin-fido2-hmac] has no form of PIN caching__.

For each decryption I have to _enter my PIN and touch my Yubikey_. 
And as you can imagine, any non-trivial setup is going to have more than a handful of secrets. 
When you also consider this needs to be done for shared secrets as well as for each machine's secrets :cry:...

{{< figure 
    src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExM2c2am42ZTF6azBsNjJzbW5ldWFlNGZjcDdsczVqNWFhZm82NTNrZyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/7NoNw4pMNTvgc/giphy.gif"
    caption="Actual footage of `clan secrets users add-key brian age1....`"
>}}

If I had stayed with [age-plugin-fido2-hmac], adding a new user key would have been prohibitively expensive and a short
path to some form of repetitive strain injury. 
I _could_ have used a key which didn't require PIN entry, but I wasn't comfortable with that. 

In the end, I moved to [age-plugin-yubikey], as it supports PIN caching and can also be configured to cache 
presence checks (up to 15 seconds). 
There is still an issue with [pcscd] aggressively [powering off my yubikey](https://github.com/str4d/age-plugin-yubikey/issues/198) 
after 5 seconds and ruining the PIN caching, but for day-to-day usage with Clan it works well enough for now.

__PIN caching:__ :white_check_mark: 

## Terminal Multiplexing

By this point, having side-quested long enough, I was feeling like I was on the home straight. 
But there was one last curveball, which at the time of writing, we still don't have a good solution for: __PIN entry 
when deploying to multiple machines at once.__

When you run `clan machines update`, the Clan CLI will perform the update process concurrently for each machine in 
your configuration and blend their terminal outputs into one. 
This becomes a problem when each one of them may ask you to enter a PIN to unlock your [Yubikey]. 

{{< figure src="./update.gif" caption="concurrent deployment during `clan machines update`">}}

Whilst annoying and suboptimal, this _isn't necessarily a show-stopper_ for small Clans; 
it just means you have to update machines individually. 

Longer-term, we're still kicking around a few ideas. 
For example, it would be nice
if [age] plugins could be configured to ask for pin entry using something like `ssh-askpass`. 

__Concurrent PIN entry__: :x:

## Summary

It took me longer than I would have hoped to _just run [Data Mesher] in a Clan of my own_ :joy:, 
but along the way there have been some much-needed improvements to Clan itself and, for me personally, 
I'm left with a much better understanding of [age], [Yubikeys] and [sops]. 

We will continue to look at ways of improving [Yubikey] integration with Clan. 

And in the meantime, please bear in mind there are still a few rough edges :pray:. 



[Data Mesher]: https://git.clan.lol/clan/data-mesher
[NixOS]: https://nixos.org
[VM tests]: https://wiki.nixos.org/wiki/NixOS_VM_tests
[Clan module]: https://docs.clan.lol/reference/clanModules/data-mesher/
[Pinpox]: https://github.com/pinpox
[sops-nix]: https://github.com/Mic92/sops-nix
[Yubikeys]: https://www.yubico.com/
[Yubikey]: https://www.yubico.com/
[age]: https://github.com/FiloSottile/age
[sops]: https://github.com/getsops/sops
[secrets management]: https://docs.clan.lol/getting-started/secrets/
[age-plugin-fido2-hmac]: https://github.com/olastor/age-plugin-fido2-hmac
[age-plugin-yubikey]: https://github.com/str4d/age-plugin-yubikey
[Vars]: /blog/vars 
[pcscd]: https://linux.die.net/man/8/pcscd